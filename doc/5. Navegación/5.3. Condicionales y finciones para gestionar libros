Condicionales y funciones para gestionar libros en la aplicaci칩n

Resumen
쮺칩mo identificamos si un usuario tiene un libro o no?

En el contexto de una aplicaci칩n de gesti칩n de libros, es fundamental poder determinar si un usuario tiene un libro espec칤fico. En el ejercicio anterior, el objetivo era modificar la vista para reflejar si un usuario ya cuenta con un libro o no. Esta informaci칩n es crucial para personalizar la interacci칩n del usuario con la plataforma, ofreciendo opciones personalizadas como calificar el libro o eliminarlo de su lista.

Para implementar esta funcionalidad, partimos de la vista, donde a침adiremos un condicional que muestre diferentes opciones seg칰n el estado del libro:

if (G\App\User\Identity::hasBook($bookId)) {
    // L칩gica para cuando el usuario tiene el libro
} else {
    // L칩gica para cuando el usuario no tiene el libro
}

Este fragmento de c칩digo eval칰a si el usuario ha registrado el libro como suyo y, en funci칩n de ello, despliega las acciones correspondientes.
쮺칩mo implementamos la funci칩n hasBook en el modelo de usuario?

La funci칩n hasBook es clave para determinar la pertenencia de un libro en el modelo de usuario. Se verifica si el libro espec칤fico est치 asociado al usuario mediante una consulta a la base de datos.

public function hasBook($bookId) {
    $userBooks = UserBook::where([
        'user_id' => $this->id,
        'book_id' => $bookId
    ])->get();

    return !empty($userBooks);
}

En este c칩digo:

    Se realiza una consulta sobre la tabla UserBook buscando coincidencias de usuario y libro.
    El m칠todo where filtra los registros que coinciden con el user_id y book_id.
    Si el arreglo resultante no est치 vac칤o, significa que el usuario posee el libro, retornando true. Caso contrario, se retorna false.

쯈u칠 hacemos despu칠s de identificar un libro como propio?

Una vez que se confirma que el usuario posee un libro, se ofrecen dos opciones en la vista: calificar el libro o indicar que ya no lo posee. La calificaci칩n se realiza mediante un formulario que env칤a la nota al controlador BookScore.
Implementaci칩n del formulario de calificaci칩n

Como parte de la futura implementaci칩n, se dise침ar치 un formulario para que los usuarios califiquen sus libros. Este formulario enviar치 una calificaci칩n del 1 al 5 al controlador BookScore, encarg치ndose de recibirla y procesarla adecuadamente en el sistema.

<form action="/book-score" method="post">
    <label for="rating">Calificar este libro:</label>
    <select id="rating" name="rating">
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
    </select>
    <button type="submit">Enviar</button>
</form>

Esta implementaci칩n no solo mejora la experiencia del usuario, permiti칠ndole interaccionar y dar feedback sobre sus libros, sino que tambi칠n crea un sistema m치s din치mico que puede adaptarse a futuras funcionalidades, como la revaluaci칩n de libros o el an치lisis de datos de calificaci칩n.



Procedimiento:
--------------

Ya podemos agregar libros a nuestra repisa, pero sigue mostrando el boton.

Si ya tengo el libro no debe dar la posibilidad de agregar nuevo libro, tenemos dos opciones, y calificar entre 1 y 5 nada mas, esas seran la forma para entender conceptos como, extender mas el modelo para entender si los tengo no, verlo desde la vista, cuando la logica ya estan cargados,

Empezaremos desde la vista.

en detail.tpl.

Agregamos 

{if Yii::$app->user->identity->hasBook($book->id)}
ya lo tengo
{else}
    <p>{Html::a('Tengo este libro', ['book/i-own-this-book', 'book_id' => $book->id]) nofilter}</p>

    <p>{Html::a('Regresar a la lista', ['book/all'], ['class' => 'btn btn-primary']) nofilter}</p>
{/if}

Posteriormente abril쯠os la clase del modelo usuario

User.php

    public function hasBook($book_id):bool{
        $ub = UserBook::find()->where([
            'user_id' => $this->id,
            'book_id' => $book_id
         ])->one();
    }

uno o todos, estando en producci칩n tendriamos que tener claro que habria un aregla de que un usuario podria tener un libro, no se tiene entonces, por meras formas de educaci칩n, deberia ser solo uno.

si esta vacio $ud no es un arreglo, 

public function hasBook($book_id):bool{
        $ub = UserBook::find()->where([
            'user_id' => $this->id,
            'book_id' => $book_id
         ])->all();
         if(empty($ub)){
            return false;

         }
         return true;
    }

Funciona exclusivamante para temas, educacionales, se puede mejorar la logica, con esto sera mas que suficiente. Lo que estamos consiguiendo con esta fucnion es saber si el usuario que tiene registrado como suyo, tal o cual libro.

Para ello vamos al browser.

Hicimos varios movimientos dentro de varios archivos


Vamos a empezar por Bookcontroller.
   public function actionDetail($id){

        // Buscar el libro con su autor relacionado
        $book = Book::find()->with('author')->where(['book_id' => $id])->one();



        //$book = Book::findOne($id);


        // Por defecto, el usuario no tiene el libro
        $userHasBook = false;


        // Verificar si el libro existe
        if(empty($book)){
            //TODO: Error
            //return "Libro no encontrado";
            //return $this->redirect(['site/index']);

            Yii::$app->session->setFlash('error', 'ese libro no existe');

            // Podemos sustituir con el siguiente shortcut
            return $this->goHome();

        }

        // Si el usuario est치 autenticado, verificar si ya tiene ese libro
        if (!Yii::$app->user->isGuest) {
            $userHasBook = Yii::$app->user->identity->hasBook($book->id);
        }

        // Renderizar la vista con las variables necesarias
        return $this->render('detail.tpl', [
            'book' => $book,
            'userHasBook' => $userHasBook,
        ]);


        // return $book->title;
        //return $book->toString();
         $flash = null;
        if (Yii::$app->session->hasFlash('success')) {
            $flash = Yii::$app->session->getFlash('success');
        } elseif (Yii::$app->session->hasFlash('error')) {
            $flash = Yii::$app->session->getFlash('error');
        }

        return $this->render('detail.tpl', [
            'book' => $book,
            'flash' => $flash,
        ]);
    }

Nos pasamos a los modelos
Book.php


    public static function primaryKey()
    {
        return ['book_id'];
    }


User.php
  public function hasBook($book_id): bool
    {
        return UserBook::find()
            ->where(['user_id' => $this->id, 'book_id' => $book_id])
            ->exists();
    }

modificamos la vista detail.

{use class="yii\helpers\Html"}

{use class="Yii"}

<h1>{$book->title|escape}</h1>
<p>Un libro escrito por <strong>{$book->author->name|escape}</strong>.</p>

{if $userHasBook}
    <p>Ya lo tengo</p>
{else}
    <p>{Html::a('Tengo este libro', ['book/i-own-this-book', 'book_id' => $book->id]) nofilter}</p>
    <p>{Html::a('Regresar a la lista', ['book/all'], ['class' => 'btn btn-primary']) nofilter}</p>
{/if}


Ahora tenemos y pdemos mencionar que ya tenemos
para ello enel condicional de la vista.

Calificamos del 1 al 5 que es la forma de como vamos a mandar post hacia otro controlador.

En la siguente secion es lo que se trabajara 

    //formulario->['book/score']
    // 1 - 5
    //Ciero el formulario

enviara a controlador book*/score

public function actionDetail($id)
{
    // Buscar el libro con su autor relacionado
    $book = Book::find()->with('author')->where(['book_id' => $id])->one();

    // Verificar si el libro existe
    if (empty($book)) {
        Yii::$app->session->setFlash('error', 'Ese libro no existe');
        return $this->goHome();
    }

    // Verificar si el usuario tiene el libro
    $userHasBook = false;
    if (!Yii::$app->user->isGuest) {
        // 游녢 OJO: usa 'book_id' en lugar de 'id'
        $userHasBook = Yii::$app->user->identity->hasBook($book->book_id);
    }

    // Leer mensajes flash si existen
    $flash = null;
    if (Yii::$app->session->hasFlash('success')) {
        $flash = Yii::$app->session->getFlash('success');
    } elseif (Yii::$app->session->hasFlash('error')) {
        $flash = Yii::$app->session->getFlash('error');
    }

    // Renderizar la vista con todos los datos necesarios
    return $this->render('detail.tpl', [
        'book' => $book,
        'userHasBook' => $userHasBook,
        'flash' => $flash,
    ]);
}

La vista quedo:

{use class="yii\helpers\Html"}

{if $flash}
    <div class="alert alert-success">
        {$flash}
    </div>
{/if}

<h1>{$book->title|escape}</h1>
<p>Un libro escrito por <strong>{$book->author->name|escape}</strong>.</p>

{if $userHasBook}
    <p>Ya lo tengo</p>
    <p>
        {Html::a('Ya no lo tengo', ['book/i-dont-own-this-book', 'book_id' => $book->book_id]) nofilter}
    </p>

    {* Aqu칤 podr칤as incluir el formulario para calificar o lo que necesites *}
     {*formulario->['book/score']*}
     {*1 - 5*}
    {*Ciero el formulario*}
{else}
    <p>
        {Html::a('Tengo este libro', ['book/i-own-this-book', 'book_id' => $book->book_id]) nofilter}
    </p>
{/if}




