Active Record

    Integraci√≥n de Base de Dattos en Frameworks PHP y Ruby

¬øQu√© es ActiveRecord y por qu√© es tan poderoso?

El ActiveRecord es una de las caracter√≠sticas m√°s impresionantes de los frameworks modernos, y su implementaci√≥n puede encontrarse en diferentes lenguajes y plataformas como Yii en PHP, Ruby on Rails, y Django. Este patr√≥n ofrece una manera de sincronizar nuestro sistema de clases y objetos con nuestra base de datos, reflejando en cada tupla una representaci√≥n directa de un modelo en nuestro sistema.
¬øC√≥mo funciona ActiveRecord?

ActiveRecord permite que lo que hagas en la base de datos se refleje autom√°ticamente en el sistema y viceversa. Al hacer cambios en el sistema, esos cambios son v√°lidos en la base de datos, siguiendo ciertas reglas b√°sicas. Esto no solo ahorra tiempo, sino que tambi√©n simplifica el desarrollo al ofrecer una estructura m√°s clara y unificada.
¬øC√≥mo implementar ActiveRecord en Yii?

Para poner en marcha ActiveRecord en Yii, es fundamental hacer unas configuraciones iniciales correctas:

    Conectar con la base de datos: Aunque la conexi√≥n ya est√° establecida de manera invisible, debemos configurar c√≥mo buscar y relacionar los datos.

    Cambios en la clase modelo:
        Cambiaremos la extensi√≥n de model a ActiveRecord.
        Definimos la tabla a la que se asociar√° el modelo usando public static function tableName().
        Yii asume que nuestras tablas contienen una columna ID, lo cual puede ser sobreescrito si nuestra estructura es distinta.

    Guardar cambios en la base de datos: Una vez instanciado un nuevo objeto de un modelo, con ActiveRecord podemos guardar los datos simplemente llamando al m√©todo save().

public static function tableName() {
    return 'books';
}

// Guardar un nuevo registro
$book = new Book();
$book->title = "Nuevo libro";
$book->save();

¬øQu√© errores comunes podr√≠as encontrar?

Durante la implementaci√≥n pueden surgir ciertos errores como:

    Falta de valores por defecto: Si una columna en la base de datos no permite valores nulos, debe tenerse un valor predeterminado. Por ejemplo, si author ID necesita un valor, puedes asignar 1 temporalmente en desarrollo.

    Columnas y lenguajes cruzados: Es crucial asegurarse de que las columnas usadas y los lenguajes aplicados concuerden con las definiciones establecidas.

    Restricciones de caracteres: Si el t√≠tulo del libro excede la definici√≥n del varchar, deber√≠as ajustar el esquema de la base de datos o controlar el valor desde el c√≥digo.

ALTER TABLE books MODIFY COLUMN title VARCHAR(500);

¬øPor qu√© explorar m√°s all√° de ActiveRecord?

Una vez que entiendas c√≥mo funciona ActiveRecord, puedes realizar operaciones m√°s complejas, como traer, modificar y guardar informaci√≥n de la base de datos, proporcionando una capa de abstracci√≥n que permite desarrollar aplicaciones m√°s robustas y escalables.

    Recuperaci√≥n y manipulaci√≥n de datos: Puedes operar con datos que provienen directamente de la base de datos, ofreciendo una flexibilidad impresionante en el manejo de informaci√≥n.

    Modificaciones eficientes: Al realizar operaciones directamente en el modelo, se minimiza el c√≥digo y se mantiene la l√≥gica centralizada y eficiente.

Este es solo el comienzo del inmenso potencial que ActiveRecord puede ofrecer. 



Archivos:
----------

klvst3rController.PHP



<?php

namespace app\commands;

use yii\console\Controller;
use yii\console\ExitCode;

use app\models\Book;

/**
 * Comando para clase, de prueba
 */
class PlatziController extends Controller {

  /**
   * Suma los valores de los dos par√É¬°metros
   */
  public function actionSuma($a, $b = 17) {
    $result = $a + $b;
    printf("%0.2f\n", $result);
    return ExitCode::OK;
  }

  public function actionBooks ($file) {
    $f=fopen√Ø¬ºÀÜ$file√Ø¬º≈í "r"√Ø¬º‚Ä∞√Ø¬º‚Ä∫
    while(! feof($f)) {
      $data = fgetcsv($f);
      if !empty($data[1]) && !empty($data[2])) {
      $book = new Book;
      $book->title = $data[1];
      $book->author_id = 1;
      $book = save();
      printf("%s\n", $book->toString());
      }
    fclose($f);
    return ExitCode::OK;
    √Ø¬Ω¬ù
  √Ø¬Ω¬ù


  Modelo Book.php

  <?php

namespace app\models;

use yii\db\ActiveRecord;

class Book extends ActiveRecord {
  public $title; 
  public $author;

  public static function tableName() {
    return 'books';
  }

  public function getId() {
    return $this->book_id;
  }

  public function toString () {
    return sprintf("(%d) %s", $this->id, strtoupper($this->title));
  }
}



alter.sql

    alter table books modify column title varchar(500);



Referencias:
------------


https://www.yiiframework.com/doc/guide/2.0/es/db-active-record


Comentarios:
------------


Saludos estaba con problemas de conexi√≥n a la BD si persiste revisen primero si tienen activado la opci√≥n a la BD, por favor, esto es con el siguiente comando:

php -m | grep pdo_mysql

sudo apt update

sudo apt install php-mysql

Esto es en WSDL no ten√≠a activado el controlador de MYSQL.





Destaco dos puntos importantes en esta clase.

Ocurrio un ‚ÄúTeachable Moment‚Äù (Momento de ensenanza) demasiado importante cuando la data se trunco y se modifico manualmente la tabla de la base de datos.

En un ambiente de trabajo cuando esto sucede se debe recurrir a una soluci√≥n que mantenga a tu equipo de trabajo informado o por lo menos que se deje constancia de lo sucedido.

    Entonces podemos recurrir a las migraciones, devolver la creaci√≥n de la tabla, corregir la migraci√≥n y volver a migrar las tablas.
    O otra opci√≥n crear una nueva migraci√≥n que altere la tabla y corrija el tama√±o del campo.

El segundo punto es que me queda un sin sabor con respecto a Yii, apenas lo estoy aprendiendo, pero considero que el modelo debi√≥ prevenir la carga de una parte de los registros e informar del truncamiento antes que ocurriera. Mediante un COMMIT TRANSACTION o algo por el estilo.





ActiveRecord es un patr√≥n de dise√±o utilizado en el √°mbito del desarrollo de software, especialmente en el contexto de aplicaciones que interact√∫an con bases de datos. En este patr√≥n, cada clase representa una tabla en la base de datos, y cada instancia de la clase representa una fila en dicha tabla. Las clases ActiveRecord proporcionan m√©todos para realizar operaciones CRUD (Crear, Leer, Actualizar, Eliminar) directamente sobre las filas de la base de datos, lo que simplifica la manipulaci√≥n de datos y mejora la legibilidad del c√≥digo.

As√≠ se define un ActiveRecord:

namespace app\models;

use yii\db\ActiveRecord;

class Post extends ActiveRecord
{
    // Especificamos el nombre de la tabla asociada a este modelo
    public static function tableName()
    {
        return 'post';
    }

    // Definimos las reglas de validaci√≥n para los atributos
    public function rules()
    {
        return [
            [['title', 'content'], 'required'],
            [['title'], 'string', 'max' => 255],
            [['content'], 'string'],
        ];
    }
}

```namespace app\models;



use yii\db\ActiveRecord;



class Post extends ActiveRecord

{

       // Especificamos el nombre de la tabla asociada a este modelo

       public static function tableName()

       {

           return 'post';

       }



       // Definimos las reglas de validaci√≥n para los atributos

       public function rules()

       {

           return \[

               \[\['title', 'content'], 'required'],

               \[\['title'], 'string', 'max' => 255],

               \[\['content'], 'string'],

           ];

       }

}




Seguimiento de archivos:

ActiveRecord
Es la capacidad de imitar un modelo en nuestro sistema directamente en la bd, y que exista unicidad en cada tupla y un modelo que se instancia y se crea.

Todo lo que se tenga en la bd se vea reflejado en el sistema.

Todolo que se cree en el sistema desarrollando, se vea reflejado en la bd.


Se deja de extendar a model 


use yii\db\ActiveRecord;

class Book extends ActiveRecord
{
    // public $title;
    // public $author;


    public static function tableName(){
        return 'books';
    }

    public function getID(){
        return $this->id;
    }
    
    public function toString() {
        return sprintf("(%d) %s", $this->id, ucapitalize($this->title));
    }
}


con esto ya tenemos un arelacion uno  auna en la bd desde nuestro sistema


Por lo tanto en el controlador 

 public function actionBooks ($file) {
        $f=fopen($file, "r"); //Se abre el archivo
        while(!feof($f)) {
          $data = fgetcsv($f);

          //si existen elementos vacios se filtra mediante un if
          if(!empty($data[1]) && !empty($data[2])) {
            //print_r($data);
            //Se crea un nuevo book
            $book = new Book; //Se instancia un book, creando un active record

            $book->title = $data[1]; //se le agnga el titulo
            //$book->author = $data[2]; //esta relacion se hara despues

            //Regresamos invocamos a la funcion quick y despues lo imprime
            //$book = $this->quick($book);

            //Es necesario guardar la informaci√≥n, para ello.
            $book->save();//se salva

            printf("%s\n", $book->toString());


          } 


Para ello en la bd


mysql> select * from books;

Verificar que esta vacio.

Ejecutamos nuestro comando
    $ php yii klvst3r/books local/books.csv


En el modelo se intenta utilizar mayusculas pero marca error.

 public function toString() {
        return sprintf("(%d) %s", $this->id, ucapitalize($this->title));
    }

Para devolver a mayusculas pero me infica error
ChatGPT said:

Gracias por compartir el fragmento. El error ocurre porque est√°s utilizando una funci√≥n ucapitalize() que no existe en PHP por defecto ni en Yii. Si deseas poner en may√∫scula solo la primera letra de la cadena, deber√≠as usar la funci√≥n nativa de PHP ucfirst().
Soluci√≥n

Cambia esta l√≠nea:

return sprintf("(%d) %s", $this->id, ucapitalize($this->title));

Por:

return sprintf("(%d) %s", $this->id, ucfirst($this->title));

¬øQu√© hace ucfirst()?

Convierte solo la primera letra del string en may√∫scula. Por ejemplo:

ucfirst("ejemplo") // devuelve "Ejemplo"

Si lo que quieres es convertir todas las letras a may√∫sculas, usa strtoupper():

strtoupper("ejemplo") // devuelve "EJEMPLO"

¬øQuieres que la primera letra de cada palabra est√© en may√∫scula (como en un t√≠tulo)? Entonces usa ucwords():

ucwords("ejemplo de texto") // devuelve "Ejemplo De Texto"




El ejecutar:

 php yii klvst3r/books local/books.csv
Exception 'yii\db\Exception' with message 'SQLSTATE[HY000] [2002] No such file or directory'

in /home/klvst3r/dev/yii/thebookblub/vendor/yiisoft/yii2/db/Connection.php:648

Error Info:
Array
(
    [0] => HY000
    [1] => 2002
    [2] => No such file or directory
)

Caused by: Exception 'PDOException' with message 'SQLSTATE[HY000] [2002] No such file or directory'

in /home/klvst3r/dev/yii/thebookblub/vendor/yiisoft/yii2/db/Connection.php:722



Marca error


Vams a solucionar en el controlador de la siguiente manera:


Hay un error ya que la llongitud de la bd en el titulo de los libros debe ser mayor de 100 caracteres.


Modificaremos la BD
    mysql> alter table boks modify column title varchar(500)


En la ejecuci√≥n nos genero un error derivado a diversas causas que indicaremos:

Tomando en consideraci√≥n que el primer error fue:

    SQLSTATE[HY000] [2002] No such file or directory

1. significa que Yii no puede conectarse a tu base de datos MySQL porque no encuentra el socket o direcci√≥n del servidor.

Este error es com√∫n cuando:

    Est√°s usando localhost como host en vez de 127.0.0.1 en sistemas Unix-like.

    PHP (y por tanto Yii) busca el socket de MySQL en un lugar distinto al que realmente est√°.

    MySQL no est√° corriendo.

La soluci√≥n es     

Edita tu archivo de configuraci√≥n de base de datos (normalmente: config/db.php) y aseg√∫rate de que el host sea 127.0.0.1 en lugar de localhost.
Antes:

'dsn' => 'mysql:host=localhost;dbname=thebookclub',

Despu√©s:

'dsn' => 'mysql:host=127.0.0.1;dbname=thebookclub',

Esto forzar√° la conexi√≥n TCP en lugar del socket.


Pero en nuestro caso el archivo de configuraci√≥n se encuentra en 

    local/variables_local.sh


2. al estar las variables de configuraci√≥n aisladas. probablemente no estan definidas correctaente y eso es por que entre la definicion de las variables y su valor dejamos espacios, modificamos nuestro archivo de variables de configuraci√≥n:

    export db_host=127.0.0.1  # En sistemas unix no llevan simbolo de $ para dar de alta las variables
    export db_name=thebookclub
    export db_user=klvst3r
    export db_pass=desarrollo
    export bd_port=3306

    # Obtenido de https://www.random.org/strings/ 
    export salt=uAh2hbHUPao10OyQsTz2vYym0fgmea!K # cadena de caracteres aleatoria servira posteriormente para hasear datos

3. Podemos observar que cambiamos     

de localhost a 127.0.0.1 directamente en las variables de entorno:

Verifica c√≥mo est√°s definiendo tus variables de entorno. Si usas un archivo .env (o exportas en la terminal), aseg√∫rate de que db_host sea:

db_host=127.0.0.1

    No uses localhost a menos que quieras usar sockets.


Asi entonces ya teiendo deifnidas nuestras variables vamos a cargarls 

yuna soluci√≥n rapida es no cargar variables de entorno:

colocamos la directiva en db.php la conexi√≥n:

return [
    'class' => 'yii\db\Connection',
    'dsn' => 'mysql:host=127.0.0.1;dbname=thebookclub',
    'username' => 'tu_usuario',
    'password' => 'tu_contrase√±a',
    'charset' => 'utf8',
];


Esto aislar√° el problema a la conexi√≥n sin depender de variables de entorno.


Pero si queremos utilizar las variables de entorno, continuamos:

Perfecto, si tienes tus variables definidas en un archivo llamado local/variables_local.sh, puedes cargarlas en tu entorno actual de terminal con el siguiente comando:

source local/variables_local.sh

    ‚úÖ Esto funciona si est√°s en la ra√≠z de tu proyecto y la ruta local/variables_local.sh es relativa desde ah√≠.

üìå Aseg√∫rate de que el archivo est√© bien estructurado

El archivo variables_local.sh debe tener el formato:

export db_host=127.0.0.1
export db_name=thebookclub
export db_user=root
export db_pass=tu_contrase√±a

Cada variable debe estar exportada, de lo contrario getenv() no las podr√° acceder desde PHP.
üîÅ ¬øY si quiero que se carguen autom√°ticamente al abrir la terminal?

Puedes agregar esta l√≠nea a tu archivo ~/.bashrc, ~/.zshrc o ~/.profile dependiendo de tu shell:

source /ruta/completa/a/local/variables_local.sh



Como estamos utilizando fish 

Opci√≥n 1: ‚ö†Ô∏è Corregir el archivo .sh para bash y usarlo temporalmente desde bash

Si solo lo necesitas para correr yii ocasionalmente:

bash -c "source local/variables_local.sh && php yii ..."

Pero primero corrige el archivo variables_local.sh para que sea compatible con bash:

export db_host=127.0.0.1
export db_name=thebookclub
export db_user=klvst3r
export db_pass=desarrollo

Sin espacios alrededor del =.

Opci√≥n 2: üêü Adaptar tus variables para fish shell

Crea un archivo local/variables_local.fish con contenido as√≠:

set -gx db_host 127.0.0.1
set -gx db_name thebookclub
set -gx db_user klvst3r
set -gx db_pass desarrollo

Y luego ejec√∫talo as√≠:

source local/variables_local.fish

üîÅ Recomendaci√≥n general

Ya que est√°s usando fish, considera mantener tus variables permanentes usando:

set -Ux db_host 127.0.0.1

Esto las guarda para siempre en el entorno de usuario (puedes verlas con set -U).


Y luego volver a ejecutar tu comando:

php yii klvst3r/books local/books.csv


Se puede probar sin variables de entorno:

Edita temporalmente tu config/db.php y reemplaza:

'dsn' => sprintf("mysql:host=%s;dbname=%s", getenv('db_host'), getenv("db_name")),

por:

'dsn' => 'mysql:host=127.0.0.1;dbname=thebookclub',

Y deja directamente los datos as√≠:

'username' => 'klvst3r',
'password' => 'desarrollo',

Si eso funciona, el problema est√° 100% en c√≥mo se est√°n leyendo las variables de entorno.
¬øQuieres que revisemos si PHP est√° reconociendo tus variables?

Puedes poner justo antes de que Yii cree la conexi√≥n (por ejemplo, en el mismo script donde corres el comando):

var_dump(getenv('db_host'));
exit;

Es importante que las variables sean exportadas para que se puedan cargar el el frameworks
podemos hacer asi:


1. ‚ö†Ô∏è La variable db_name no est√° definida o exportada

Aseg√∫rate de haber exportado tambi√©n db_name, por ejemplo:

set -gx db_name thebookclub

Luego verifica que est√© presente:

echo $db_name




finalmente como la inforamci√≥n se guardo, y se volvemos a interntar guardar. marcaria un error

Con sto cada vez que se crea un objeto y se guarde en el codigo, sin hacer algo mas se almacene en la Bd.

